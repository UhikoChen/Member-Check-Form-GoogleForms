<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icon.ico">
    <link rel="apple-touch-icon" href="icon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>206旅二營一連專車統計訊息產生器</title>

    <style>
      *{
        box-sizing: border-box;
        font-size: 12pt;
        font-family: sans-serif;
      }

      body{
        margin: 0;
        padding: 0;
      }

      a{
        color: unset;
        text-decoration: none;
      }

      i{
        padding-right: 15px;
        font-size: 26pt;
      }

      input{
        border-radius: 6px;
      }

      textarea{
        border-radius: 6px;
      }

      .container{
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }

      .middleFlex{
        display: flex; 
        flex-wrap: wrap; 
        align-items: center; 
        justify-content: space-between;
      }

      .textPadding{
        padding: 10px 0;
      }
    </style>
  </head>
  <body>
    <div style="padding: 20px 0; font-size: 18pt; text-align: center; font-weight: 600; background-color: coral; color: white; margin-bottom: 10px;">206旅二營一連 專車統計訊息產生器</div>

    <div class="container" style="padding-bottom: 150px;">
      <div class="middleFlex" style="padding: 20px 0;">
        <div>
          <span>單位：</span>
          <input id="battalion" style="width: 80px;" value="一連"></input>
        </div>

        <div>
          <span>放假日期：</span>
          <input id="startDate" type="date">
        </div>

        <div>
          <span>收假日期：</span>
          <input id="endDate" type="date">
        </div>
      </div>  
      
      <div class="middleFlex" style="padding:10px 0;">
        <div>
          <span style="padding: 20px 0;">請上傳Google表單的CVS：</span>
          <input type="file" accept="text/csv">
        </div>
        
        <progress value="0"></progress>
      </div>

      <div style="display: grid; grid-template-columns: repeat(2,auto); column-gap: 20px;">
        <div>
          <div class="textPadding">乘車名單：</div>
          <textarea id ="MessageText" name="messageText" rows="30" style="width: 100%;"readonly required></textarea>
        </div>

        <div>
          <div class="textPadding">自行出入營名單：</div>
          <textarea id ="SelfText" name="messageText" rows="30" style="width: 100%;"readonly required></textarea>
        </div>
      </div>
      
    </div>

    <div style="position:fixed; bottom: 0; width: 100%; background-color:coral; padding: 10px 0; margin-top: 20px;">
      <div class="container">
        <div style="display: flex; flex-wrap: nowrap;">
          <div style="width: 70%;">
            <div style="font-size: 18pt; color:white; padding: 15px 0;">Developer</div>
            <div style="font-size: 14pt; color:white; padding:10px 0;">UhikoChen</div>
          </div>
          <div>
            <div style="font-size: 18pt; color:white; padding: 15px 0;">Contact</div>
            <a href="https://github.com/UhikoChen" target="_blank"><i class="fa-brands fa-github"></i></a>
            <a href="https://www.instagram.com/uhiko_chen/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
          </div>
          
        </div>
      </div>
    </div>
    
    <script src="https://kit.fontawesome.com/978ee80c9d.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // changeJSON
      let csvJson = "";

      // 基隆離營
      let goKeelungArray = [];

      // 基隆入營
      let fromKeelungArray = [];

      // 桃園離營
      let goTaoyuanArray = [];

      // 桃園入營
      let fromTaoyuanArray = [];

      // 苗栗離營
      let goMiaoliArray = [];

      // 苗栗入營
      let fromMiaoliArray = [];

      // 台中離營
      let goTaichungArray = [];

      // 台中入營
      let fromTaichungArray = [];

      // 自行出營
      let goSelfArray = [];

      // 自行入營
      let fromSelfArray = [];
      
      // date
      let startDate = "";
      let endData = "";

      window.onload = (event) => {
        main();
      }

      function main(){
        var inputFile = document.querySelector("input[type='file']");
        
        inputFile.onchange = (event) => {
          var file = inputFile.files[0];

          var fileReader = new FileReader();
          fileReader.readAsText(file, "utf-8");

          var progress = document.querySelector("progress");
          progress.max = file.size;
          progress.value = 0;
          fileReader.onprogress = (event) => {
            progress.value = event.loaded;
          }

          fileReader.onload = (event) => {
            console.log(event, fileReader);
           
            csvJson = csvJSON(fileReader.result); 
            console.log(csvJson);

            checkJSON(csvJson);
          }
        }
      }

      function checkJSON(dataJson){
        for(keys in dataJson){
          if(dataJson[keys]["\"離營下車的地點\""])
          {
            if(dataJson[keys]["\"離營下車的地點\""] === '基隆 $250')
            {
              goKeelungArray.push(dataJson[keys]["\"你的學號?\""])
            }
            if(dataJson[keys]["\"離營下車的地點\""] === '桃園 $200')
            {
              goTaoyuanArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"離營下車的地點\""] === '苗栗 $200')
            {
              goMiaoliArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"離營下車的地點\""] === '台中 $250')
            {
              goTaichungArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"離營下車的地點\""] === '不搭乘離營車，將自行出營')
            {
              goSelfArray.push(dataJson[keys]["\"你的學號?\""]);
            }
          }

          if(dataJson[keys]["\"回營上車的地點\""])
          {
            if(dataJson[keys]["\"回營上車的地點\""] === '基隆 $250')
            {
              fromKeelungArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"回營上車的地點\""] === '桃園 $200')
            {
              fromTaoyuanArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"回營上車的地點\""] === '苗栗 $200')
            {
              fromMiaoliArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"回營上車的地點\""] === '台中 $250')
            {
              fromTaichungArray.push(dataJson[keys]["\"你的學號?\""]);
            }
            if(dataJson[keys]["\"回營上車的地點\""] === '不搭乘入營車，將自行回營')
            {
              fromSelfArray.push(dataJson[keys]["\"你的學號?\""]);
            }
          }     
        }
        outputJSON();
      }

      function outputJSON(){

        startDate = document.getElementById("startDate").value.slice(5).replace('-','/');
        endDate = document.getElementById("endDate").value.slice(5).replace('-','/');

        let carText = 
        `${document.getElementById("battalion").value}：

●${startDate} 休假，總人數${goKeelungArray.length + goTaoyuanArray.length + goMiaoliArray.length + goTaichungArray.length}人
      
    1.基隆：${goKeelungArray.length}員

        學號如下：${goKeelungArray.sort().join("、")}

    2.桃園：${goTaoyuanArray.length}員

        學號如下：${goTaoyuanArray.sort().join("、")}

    3.苗栗：${goMiaoliArray.length}員

        學號如下：${goMiaoliArray.sort().join("、")}

    4.臺中：${goTaichungArray.length}員 

        學號如下：${goTaichungArray.sort().join("、")}


●${endDate} 收假，總人數${fromKeelungArray.length + fromTaoyuanArray.length + fromMiaoliArray.length + fromTaichungArray.length}人
      
    1.基隆：${fromKeelungArray.length}員

        學號如下：${fromKeelungArray.sort().join("、")}

    2.桃園：${fromTaoyuanArray.length}員

        學號如下：${fromTaoyuanArray.sort().join("、")}

    3.苗栗：${fromMiaoliArray.length}員

        學號如下：${fromMiaoliArray.sort().join("、")}

    4.臺中：${fromTaichungArray.length}員

        學號如下：${fromTaichungArray.sort().join("、")}`


  let selfText = `自行出營：${goSelfArray.length}員
  
  學號如下：${goSelfArray.sort().join("、")}


  自行入營：${fromSelfArray.length}員
  
  學號如下：${fromSelfArray.sort().join("、")}
  `

        document.getElementById("MessageText").value = carText;
        document.getElementById("SelfText").value = selfText;
      }

      function csvJSON(csv){

        var lines=csv.split("\n");
        var result = [];
        var headers = lines[0].split(",");

        for(var i=1; i<lines.length; i++) {
          var obj = {};

          var row = lines[i],
            queryIdx = 0,
            startValueIdx = 0,
            idx = 0;

          if (row.trim() === '') { continue; }

          while (idx < row.length) {
            /* if we meet a double quote we skip until the next one */
            var c = row[idx];

            if (c === '"') {
              do { c = row[++idx]; } while (c !== '"' && idx < row.length - 1);
            }

            if (c === ',' || /* handle end of line with no comma */ idx === row.length - 1) {
              /* we've got a value */
              var value = row.substr(startValueIdx, idx - startValueIdx).trim();

              /* skip first double quote */
              if (value[0] === '"') { value = value.substr(1); }
              /* skip last comma */
              if (value[value.length - 1] === ',') { value = value.substr(0, value.length - 1); }
              /* skip last double quote */
              if (value[value.length - 1] === '"') { value = value.substr(0, value.length - 1); }

              var key = headers[queryIdx++];
              obj[key] = value;
              startValueIdx = idx + 1;
            }

            ++idx;
          }

          result.push(obj);
        }
        return result;
      }
    </script>
  </body>
</html>