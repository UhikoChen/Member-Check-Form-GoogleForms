<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="icon.ico">
  <link rel="apple-touch-icon" href="icon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>206旅二營一連專車統計訊息產生器</title>

  <style>
    * {
      box-sizing: border-box;
      font-size: 12pt;
      font-family: sans-serif;
    }

    html {
      min-height: 100%;
      position: relative;
    }

    body {
      margin: 0;
      padding: 0;
      /* Camouflage green */
      background-color: #78866B;
    }

    a {
      color: unset;
      text-decoration: none;
    }

    i {
      padding-right: 15px;
      font-size: 26pt;
    }

    input {
      border-radius: 6px;
    }

    textarea {
      border-radius: 6px;
      resize: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    .title-nav {
      padding: 20px 0;
      font-size: 16pt;
      text-align: center;
      font-weight: 600;
      color: white;
    }

    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      background-color: #78866B;
      padding: 10px 0;
      margin-top: 20px;
    }

    .middleFlex {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      row-gap: 10px;
    }

    input[type="file"] {
      position: fixed;
      right: 100%;
      bottom: 100%;
    }

    .custom-file-upload {
      border: 1px solid #ccc;
      display: inline-block;
      padding: 6px 12px;
      cursor: pointer;
    }

    .textPadding {
      padding: 10px 0;
    }
  </style>
</head>

<body>
  <div class="title-nav">206旅二營一連 專車統計訊息產生器</div>

  <div style="background-color: white;">
    <div class="container" style="background-color: white;">
      <div class="middleFlex" style="padding: 20px 0;">
        <div>
          <span>單位：</span>
          <input id="battalion" style="width: 80px;" value="一連"></input>
        </div>

        <div>
          <span>放假日期：</span>
          <input id="startDate" type="date">
        </div>

        <div>
          <span>收假日期：</span>
          <input id="endDate" type="date">
        </div>
      </div>

      <div class="middleFlex" style="padding:10px 0;">
        <div class="container">
          <label for="file-upload" class="custom-file-upload">
            <i class="fa fa-cloud-upload"></i>
            <span id="file-name" style="padding: 20px 0;">請選擇檔案(副檔名：csv)</span>
          </label>
          <input id="file-upload" type="file" accept="text/csv">
        </div>
        <!-- <progress value="0"></progress> -->
      </div>

      <div style="display: grid; grid-template-columns: repeat(2,auto); column-gap: 20px; padding-bottom: 200px;">
        <div>
          <div class="middleFlex">
            <div class="textPadding">搭乘專車：</div>
            <button id="CarTextBtn">Copy</button>
          </div>

          <textarea id="CarTextarea" name="messageText" rows="20" style="width: 100%;" readonly required></textarea>
        </div>

        <div>
          <div class="middleFlex">
            <div class="textPadding">自行出入：</div>
            <button id="SelfTextBtn">Copy</button>
          </div>

          <textarea id="SelfTextarea" name="messageText" rows="20" style="width: 100%;" readonly required></textarea>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">
    <div class="container">
      <div style="display: flex; flex-wrap: nowrap; justify-content: space-between; padding: 0px 20px;">
        <div>
          <div style="font-size: 18pt; color:white; padding: 15px 0;">Developer</div>
          <div style="font-size: 14pt; color:white; padding:10px 0;">UhikoChen</div>
        </div>
        <div>
          <div style="font-size: 18pt; color:white; padding: 15px 0;">Contact</div>
          <a href="https://github.com/UhikoChen" target="_blank"><i class="fa-brands fa-github"></i></a>
          <a href="https://www.instagram.com/uhiko_chen/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
        </div>

      </div>
    </div>
  </div>

  <script src="https://kit.fontawesome.com/978ee80c9d.js" crossorigin="anonymous"></script>
  <script type="text/javascript">
    // changeJSON
    let csvJson = "";
    /*
    // 基隆離營
    let goKeelungArray = [];

    // 基隆入營
    let fromKeelungArray = [];

    // 桃園離營
    let goTaoyuanArray = [];

    // 桃園入營
    let fromTaoyuanArray = [];

    // 苗栗離營
    let goMiaoliArray = [];

    // 苗栗入營
    let fromMiaoliArray = [];

    // 台中離營
    let goTaichungArray = [];

    // 台中入營
    let fromTaichungArray = [];

    // 自行出營
    let goSelfArray = [];

    // 自行入營
    let fromSelfArray = [];
    */
    // 時間設定
    let startDate = "";
    let endData = "";

    window.onload = (event) => {
      main();
    }

    const select = (DOM) => document.querySelector(DOM);

    select('#CarTextBtn').addEventListener('click', () => {
      select('#CarTextarea').select();
      document.execCommand("copy");
      alert("複製成功！");
    })

    select('#SelfTextBtn').addEventListener('click', () => {
      select('#SelfTextarea').select();
      document.execCommand("copy");
      alert("複製成功！");
    })

    function main() {
      var inputFile = document.querySelector("input[type='file']");

      inputFile.onchange = (event) => {
        var file = inputFile.files[0];

        var fileReader = new FileReader();
        fileReader.readAsText(file, "utf-8");

        // var progress = document.querySelector("progress");
        // progress.max = file.size;
        // progress.value = 0;
        // fileReader.onprogress = (event) => {
        //   progress.value = event.loaded;
        // }

        fileReader.onload = (event) => {
          console.log(event, fileReader);
          document.getElementById('file-name').innerHTML = file.name;
          csvJson = csvJSON(fileReader.result);
          console.log(csvJson);

          outputJSON(csvJson);
        }
      }
    }

    function outputJSON(data) {
      let
        goKeelung = go(data, "基隆 $250"),
        fromKeelung = from(data, "基隆 $250"),
        goTaoyuan = go(data, "桃園 $200"),
        fromTaoyuan = from(data, "桃園 $200"),
        goMiaoli = go(data, "苗栗 $200"),
        fromMiaoli = from(data, "苗栗 $200"),
        goTaichung = go(data, "台中 $250"),
        fromTaichung = from(data, "台中 $250"),
        goSelf = go(data, "不搭乘離營車，將自行出營"),
        fromSelf = from(data, "不搭乘入營車，將自行回營");

      startDate = document.getElementById("startDate").value.slice(5).replace('-', '/');
      endDate = document.getElementById("endDate").value.slice(5).replace('-', '/');
      let carText =
        `${document.getElementById("battalion").value}：

●${startDate} 休假，總人數${goKeelung.length + goTaoyuan.length + goMiaoli.length + goTaichung.length}人
      
    1.基隆：${goKeelung.length}員

        學號如下：${goKeelung.join("、")}

    2.桃園：${goTaoyuan.length}員

        學號如下：${goTaoyuan.join("、")}

    3.苗栗：${goMiaoli.length}員

        學號如下：${goMiaoli.join("、")}

    4.臺中：${goTaichung.length}員 

        學號如下：${goTaichung.join("、")}


●${endDate} 收假，總人數${fromKeelung.length + fromTaoyuan.length + fromMiaoli.length + fromTaichung.length}人
      
    1.基隆：${fromKeelung.length}員

        學號如下：${fromKeelung.join("、")}

    2.桃園：${fromTaoyuan.length}員

        學號如下：${fromTaoyuan.join("、")}

    3.苗栗：${fromMiaoli.length}員

        學號如下：${fromMiaoli.join("、")}

    4.臺中：${fromTaichung.length}員

        學號如下：${fromTaichung.join("、")}`


      let selfText = `自行出營：${goSelf.length}員
  
  學號如下：${goSelf.join("、")}


  自行入營：${fromSelf.length}員
  
  學號如下：${fromSelf.join("、")}
  `

      document.getElementById("CarTextarea").value = carText;
      document.getElementById("SelfTextarea").value = selfText;
    }
    /* 列出離營下車各地點之人員，已排序 */
    function go(data, go_place) {
      let go = data.filter((data) => {
        return data["離營下車的地點"] === go_place;
      }).map((data) => {
        return data["你的學號?"];
      }).sort();
      return go;
    }
    /* 列出回營上車各地點之人員，已排序 */
    function from(data, from_place) {
      let from = data.filter(data => {
        return data["回營上車的地點"] === from_place;
      }).map(data => {
        return data["你的學號?"];
      }).sort();
      return from;
    }

    function csvJSON(csv) {
      // Split data into lines and separate headers from actual data
      // using Array spread operator
      const [headerLine, ...lines] = csv.split('\n');

      // Use common line separator, which parses each line as the contents of a JSON array
      const parseLine = (line) => JSON.parse(`[${line}]`);

      // Split headers line into an array
      const headers = parseLine(headerLine);

      // Create objects from parsing lines
      // There will be as much objects as lines
      const result = lines
        .map((line, index) =>

          // Split line with JSON
          parseLine(line)

            // Reduce values array into an object like: { [header]: value } 
            .reduce(
              (object, value, index) => ({
                ...object,
                [headers[index]]: value,
              }),
              {}
            )
        );
      return result;
    }
  </script>
</body>

</html>